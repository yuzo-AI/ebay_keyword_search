# メルカリ-eBay価格比較ツール

Version: 2.1.0 🎉

メルカリCSVから型番を抽出し、eBay販売価格と比較して利益判定を行うツールです。

## 🆕 最新アップデート (v2.1.0)

- ✅ **Applyボタン自動検出の改善**: より確実にフィルター適用ボタンを検出
- ✅ **価格フィルター処理の最適化**: Soldタブ優先でフィルターリセット問題を解決
- ✅ **エラーハンドリング強化**: 複数のクリック方法でボタン操作の成功率向上
- ✅ **デバッグ情報の充実**: 問題発生時の原因特定が容易に

## 主な機能

- **型番自動抽出**: メルカリ商品名から型番を正規表現で抽出
- **eBay価格検索**: 抽出した型番でeBayの販売実績を検索（Seller Hub対応）
- **設定ベース利益計算**: config.yamlで利益率・固定利益を簡単調整
- **最高価格商品抽出**: 利益条件を満たす商品から最高価格を自動選択
- **価格フィルター自動適用**: 指定した価格範囲で自動フィルタリング
- **結果出力**: CSV形式で詳細な比較結果を出力

## 🎯 利益計算の仕組み

```
必要eBay価格 = メルカリ価格 × (1 + 利益率) + 固定利益
利益金額 = eBay販売価格（円換算） - メルカリ価格
```

**例**: メルカリ10,000円の商品の場合
- 10,000円 × 1.2 + 3,000円 = **15,000円以上**のeBay商品が対象

## ⚙️ 設定ファイル（config.yaml）

```yaml
profit_calculation:
  markup_rate: 0.2      # 利益率（20%）
  fixed_profit: 3000    # 固定利益（3000円）

exchange_rate:
  fixed_rate: 150.0     # 為替レート（1USD = 150円）

ebay:
  price_filter:
    enable_price_filter: true   # 価格フィルター有効/無効
    min_price: 50              # 最小価格（USD）
    max_price: 800             # 最大価格（USD）
```

### 利益設定の調整例

| 設定 | markup_rate | fixed_profit | 例（10,000円商品） |
|------|-------------|--------------|-------------------|
| 控えめ | 0.1 (10%) | 2000円 | 13,000円以上 |
| 標準 | 0.2 (20%) | 3000円 | 15,000円以上 |
| 高利益 | 0.3 (30%) | 5000円 | 18,000円以上 |

## インストール

### 1. Python環境

Python 3.8-3.13が必要です。

```bash
python --version
```

### 2. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 3. ChromeDriverの設定

webdriver-managerが自動でChromeDriverを管理するため、手動設定は不要です。

## 🚀 使用方法

### 🔧 設定対応版（推奨）

```bash
python extract_ebay_seller_hub_config.py
```

**特徴**:
- ✅ config.yamlから設定を自動読み込み
- ✅ 利益率・固定利益を簡単調整
- ✅ eBay Seller Hub対応（高精度）
- ✅ 最高価格商品を自動選択
- ✅ 価格フィルター自動適用
- ✅ Applyボタン自動検出（改善版）
- ✅ 詳細統計レポート

### 📋 実行手順

1. **CSVファイルを準備**
   ```csv
   商品名,画像URL,価格,商品URL
   Grand Seiko SBGX263,https://example.com/image.jpg,80000,https://jp.mercari.com/item/xxx
   ```

2. **設定を調整（必要に応じて）**
   ```bash
   # config/config.yamlを編集
   profit_calculation:
     markup_rate: 0.15    # 15%利益に変更
     fixed_profit: 5000   # 5000円固定利益に変更
   
   ebay:
     price_filter:
       enable_price_filter: true
       min_price: 50      # 50ドル以上
       max_price: 800     # 800ドル以下
   ```

3. **スクリプト実行**
   ```bash
   python extract_ebay_seller_hub_config.py
   # CSVファイルパスを入力: grand seiko_mercari.csv
```

4. **手動ログイン**
   - ブラウザが自動起動
   - eBayアカウントでログイン
   - Product Research画面まで進む
   - Enterキーで処理開始

### 📊 実行結果例（改善版）

```
📋 設定ファイル読み込み: config/config.yaml
💰 利益率設定: 20.0%
💰 固定利益: ¥3,000
💱 為替レート: 1USD = ¥150
💰 金額フィルター: $50 - $800 (有効)

🔄 処理中: 1/4
📝 商品名: Grand Seiko SBGX263
💰 メルカリ価格: ¥80,000
📈 必要eBay価格: ¥99,000 (利益率20.0% + 固定¥3,000)
🎯 抽出された型番: SBGX263

🔄 Soldタブを先にクリック中...
✅ Soldタブをクリックしました
✅ SOLDタブが有効です（URL確認）

💰 金額フィルターを適用中: $50 - $800
✅ Price filterボタンをクリック
✅ 最小価格入力: $50
✅ 最大価格入力: $800

🔍 Applyボタンを探しています...
🔍 ページ上の全ボタン数: 25
🔍 'Apply'テキストを含むボタン: 1
  📋 ボタン: 'Apply' - 有効: true, 表示: true
✅ Applyボタン発見（1個の候補から選択）
📋 選択されたボタン: 'Apply' (BUTTON) - 有効: true, 表示: true
✅ Applyボタンクリック成功（通常クリック）
🎉 Applyボタンのクリックに成功しました！

⏳ フィルター適用中...
✅ フィルター適用後のデータ読み込み完了
🔍 フィルター適用後の価格サンプル: ['$798.00', '$645.50', '$599.99']

✅ 設定条件クリア商品データ取得成功: SEIKO Grand Seiko SBGX263...
   価格: $798.00 (利益: ¥39,700)

📊 設定ベース利益商品統計:
   📋 設定内容:
      利益率: 20.0%
      固定利益: ¥3,000
      為替レート: 1USD = ¥150
   📊 結果:
      総商品数: 4件
      利益商品: 3件
      利益率: 75.0%
      総利益金額: ¥67,697
      平均利益: ¥22,566
```

### 🔄 従来版スクリプト

#### 並列処理版
```bash
python extract_ebay_seller_hub_parallel.py
```

#### シンプル版
```bash
python extract_ebay_data_simple.py
```

## 📁 CSVファイル形式

入力CSVファイルは以下の形式である必要があります：

| A列（必須） | B列（オプション） | C列（必須） | D列（必須） |
|-------------|-------------------|-------------|-------------|
| 商品名      | 画像URL           | 価格        | 商品URL     |

**例:**
```csv
商品名,画像URL,価格,商品URL
Grand Seiko SBGX263,https://example.com/image.jpg,80000,https://jp.mercari.com/item/xxx
Sony WH-1000XM4 ワイヤレスヘッドホン,https://example.com/image2.jpg,25000,https://jp.mercari.com/item/yyy
```

## 📊 出力ファイル

### 🎯 設定対応版の出力

`ebay_config_results_YYYYMMDD_HHMMSS.csv`

| 列 | 内容 | 例 |
|----|------|-----|
| A-D | 元のCSVデータ | 商品名、画像URL、価格、商品URL |
| E | eBay商品名 | SEIKO Grand Seiko SBGX263... |
| F | eBayURL | https://www.ebay.com/itm/xxx |
| G | eBay価格(USD) | $798.00 |
| H | eBay価格(JPY) | ¥119,700 |
| I | 利益金額 | ¥39,700 |
| J | 利益判定 | OK |

### 📈 統計レポート

実行後に以下の統計が表示されます：

```
📊 設定ベース利益商品統計:
   📋 設定内容:
      利益率: 20.0%
      固定利益: ¥3,000
      為替レート: 1USD = ¥150
   📊 結果:
      総商品数: 4件
      利益商品: 3件
      利益率: 75.0%
      総利益金額: ¥67,697
      平均利益: ¥22,566
```

### 🐛 デバッグファイル

- `debug_型番_YYYYMMDD_HHMMSS.html`: 検索結果のHTMLダンプ
- 問題発生時の原因調査に使用

## ⚙️ 設定のカスタマイズ

### 💰 利益計算設定

`config/config.yaml`で利益計算を簡単に調整できます：

```yaml
profit_calculation:
  markup_rate: 0.2      # 利益率（20%）
  fixed_profit: 3000    # 固定利益（3000円）

exchange_rate:
  fixed_rate: 150.0     # 為替レート（1USD = 150円）

ebay:
  price_filter:
    enable_price_filter: true   # 価格フィルター有効/無効
    min_price: 50              # 最小価格（USD）
    max_price: 800             # 最大価格（USD）
```

### 🎯 利益設定の例

| 用途 | markup_rate | fixed_profit | 10万円商品の例 |
|------|-------------|--------------|----------------|
| **お試し** | 0.05 (5%) | 1000円 | 106,000円以上 |
| **標準** | 0.2 (20%) | 3000円 | 123,000円以上 |
| **高利益** | 0.3 (30%) | 5000円 | 135,000円以上 |
| **超高利益** | 0.5 (50%) | 10000円 | 160,000円以上 |

### 💰 価格フィルター設定

```yaml
ebay:
  price_filter:
    enable_price_filter: true   # フィルター有効化
    min_price: 50              # 50ドル以上
    max_price: 800             # 800ドル以下
```

**価格フィルターの効果**:
- 範囲外の商品を除外して検索精度向上
- 処理時間の短縮
- より関連性の高い商品のみを対象

## 🔐 eBayログインについて

**設定対応版では手動ログインが必要です：**

1. スクリプト実行
2. Chromeブラウザが自動起動
3. eBay Seller Hubにアクセス
4. **手動でeBayアカウントにログイン**
5. Product Research画面まで進む
6. ターミナルでEnterキーを押して処理開始

⚠️ **注意**: eBay Seller Hubは認証が必要なため、自動ログインはできません。

## 🛠️ トラブルシューティング

### ❓ よくある問題と解決方法

1. **「Applyボタンが見つかりません」**
   ```
   🔍 'Apply'テキストを含むボタン: 0
   ❌ Applyボタンが見つかりません（0個の候補を検索）
   ```
   **解決方法**:
   - 価格フィルター画面が正しく開いているか確認
   - ブラウザ画面をスクロールしてApplyボタンを表示
   - ページの読み込み完了まで待機

2. **「フィルター範囲外の価格を検出」**
   ```
   ⚠️ 警告: フィルター範囲外の価格を検出: ['$24.99', '$20.00']
   ```
   **解決方法**:
   - config.yamlの価格範囲を調整
   - 検索結果が少ない場合は範囲を拡大

3. **「設定ファイルが見つかりません」**
   ```bash
   # config/config.yamlが存在するか確認
   ls config/config.yaml
   ```

4. **「型番が抽出されません」**
   - 商品名に型番（SBGX263、5645-7010等）が含まれているか確認
   - 型番パターンが合わない場合は抽出ロジックを調整

5. **「ブラウザがクラッシュします」**
   - PCのメモリ不足の可能性
   - 他のアプリケーションを閉じて再実行

### 🔧 新機能のデバッグ情報

v2.1.0では詳細なデバッグ情報が表示されます：

```
🔍 ページ上の全ボタン数: 25
🔍 'Apply'テキストを含むボタン: 1
  📋 ボタン: 'Apply' - 有効: true, 表示: true
✅ Applyボタン発見（1個の候補から選択）
📋 選択されたボタン: 'Apply' (BUTTON) - 有効: true, 表示: true
```

この情報で問題の原因を特定できます。

### 📋 デバッグ方法

1. **HTMLファイルの確認**
   ```bash
   # 生成されたHTMLファイルを確認
   ls debug_*.html
   ```

2. **設定値の確認**
   ```bash
   # 設定ファイルの内容を確認
   cat config/config.yaml
   ```

3. **CSVファイルの確認**
   ```bash
   # 入力CSVの形式を確認
   head -5 your_file.csv
   ```

## ⚠️ 注意事項

- ✅ eBayの利用規約を遵守してください
- ✅ アクセス制限を避けるため、適切な間隔で実行してください
- ✅ 大量データ処理時はPCのリソース使用量にご注意ください
- ✅ 手動ログインが必要なため、実行中はPCから離れないでください
- ✅ 価格フィルターは検索精度向上のため、適切な範囲に設定してください

## 🎉 設定変更の簡単な例

利益条件を変更したい場合：

```bash
# 1. 設定ファイルを編集
notepad config/config.yaml

# 2. 利益率を15%、固定利益を2000円、価格フィルターを有効に変更
profit_calculation:
  markup_rate: 0.15
  fixed_profit: 2000

ebay:
  price_filter:
    enable_price_filter: true
    min_price: 30
    max_price: 1000

# 3. スクリプト実行
python extract_ebay_seller_hub_config.py
```

これで設定が即座に反映されます！🚀

## 📝 更新履歴

### v2.1.0 (2025-06-25)
- ✅ Applyボタン自動検出の大幅改善
- ✅ 価格フィルター処理順序の最適化（Soldタブ優先）
- ✅ 複数のクリック方法による成功率向上
- ✅ デバッグ情報の充実
- ✅ エラーハンドリングの強化

### v2.0.0 (2024-XX-XX)
- ✅ config.yaml対応
- ✅ 設定ベース利益計算
- ✅ eBay Seller Hub対応
- ✅ 最高価格商品抽出

## ライセンス

このツールは要件定義に基づいて開発されました。商用利用時は関連する利用規約を確認してください。